# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Måne3D is a lightweight game framework for Lua 5.5 built on top of the Sokol graphics ecosystem.

- Thin Lua wrappers over Sokol libraries (auto-generated bindings)
- Runtime shader compilation via sokol-shdc
- GLM-like math library (lib/glm.lua)

## Build Commands

```bash
# Configure with CMake presets (see CMakePresets.json for available presets)
cmake --preset win-d3d11-debug       # Windows Debug with D3D11
cmake --preset win-d3d11-release     # Windows Release with D3D11
cmake --preset macos-metal-release   # macOS with Metal
cmake --preset linux-gl-debug        # Linux with OpenGL

# Build
cmake --build --preset <preset-name>

# Lint Lua code
check.bat     # Windows (requires lua-language-server in VS Code)
./check.sh    # Linux/macOS
```

### CMake Options

- `MANE3D_BUILD_EXAMPLE` - Build example executable (default: OFF)
- `MANE3D_BUILD_SHDC` - Build sokol-shdc for runtime shader compilation (default: OFF)
- `MANE3D_BUILD_SHARED` - Build as shared library (default: OFF)
- `MANE3D_USE_SYSTEM_LUA` - Use system Lua instead of bundled (default: OFF)

## Architecture

### Directory Structure

- `lib/` - Lua libraries (use `require("lib.xxx")`)
  - `glm.lua` - Math library (vec2/vec3/vec4/mat4) with LuaCATS annotations
  - `hotreload.lua` - Hot reload with file watching via lume.hotswap
  - `gpu.lua` - GC-safe GPU resource wrappers (shader, pipeline, buffer, etc.)
  - `render_pipeline.lua` - Render pass management with pcall error recovery
  - `render_target.lua` - Render target utilities
  - `util.lua` - Common utilities (shader compilation, texture loading, etc.)
- `gen/` - Generated files (gitignored)
  - `bindings/` - Lua binding C implementations
  - `types/` - Lua type definitions for IDE autocomplete
  - `licenses.c` - Third-party license data
- `src/` - Manual source files
  - `sokol_impl.c` - Sokol implementations
  - `shdc_wrapper.cc` - sokol-shdc C++ wrapper
  - `shdc_lua.c` - Lua bindings for shader compiler
- `examples/` - Sample applications
- `assets/` - External assets (gitignored, not redistributable)
  - `images/` - Shared images (LUT, noise, flow maps, etc.)
  - `<scene>/` - Scene-specific assets
    - `<scene>.lua` - Model data (generated by egg2lua.py)
    - `*.egg` - Panda3D egg files (converted from bam)
    - `tex/` - Scene textures
- `scripts/` - Build and conversion scripts
  - `bam2egg.py` - Convert .bam to .egg and copy textures
  - `egg2lua.py` - Convert .egg to Lua model data
- `deps/` - Git submodules
  - `lua/` - Lua 5.5 source
  - `sokol/` - Sokol headers and bindgen tools
  - `sokol-tools/` - sokol-shdc shader compiler source
  - `3d-game-shaders-for-beginners/` - Reference shaders and assets

### Code Generation

`gen_lua.py` generates Lua bindings from Sokol headers:
- Uses sokol/bindgen to parse headers
- Generates C modules in `gen/bindings/sokol_*.c`
- Generates Lua type stubs in `gen/types/sokol/*.lua`

`gen_licenses.py` generates `gen/licenses.c` from LICENSE files in deps/.

### Sokol Modules

- `sokol.gfx` - Graphics/rendering
- `sokol.app` - Window and event handling
- `sokol.gl` - Immediate-mode graphics
- `sokol.audio` - Audio playback
- `sokol.time` - Timing utilities
- `sokol.debugtext` - Debug text rendering
- `sokol.log` - Logging
- `sokol.shape` - Shape generation
- `mane3d.licenses` - Third-party license info
- `shdc` - Runtime shader compiler (when MANE3D_BUILD_SHDC=ON)

### Event Loop Model

Lua scripts implement callbacks:

- `init()` - One-time initialization
- `frame()` - Per-frame rendering
- `event(ev)` - Input/window events
- `cleanup()` - Shutdown

### Shader Compilation

Runtime shader compilation via sokol-shdc (requires `MANE3D_BUILD_SHDC=ON`).
Use `util.compile_shader()` helper - see `examples/breakout.lua`.

Backend detection:
- D3D11 → hlsl5
- Metal → metal_macos
- WGPU → wgsl
- OpenGL → glsl430/glsl300es

## Backends

Auto-selected per platform:
- Windows: D3D11
- macOS: Metal
- Linux: OpenGL

## Require Path Convention

Use root-relative paths for all requires:
```lua
local util = require("lib.util")
local glm = require("lib.glm")
local hotreload = require("lib.hotreload")
local camera = require("examples.deferred.camera")
```

Do NOT manipulate `package.path` in Lua code.

## Hot Reload

`lib/hotreload.lua` provides automatic hot reload:
- Hooks `require()` to watch loaded files
- Checks file mtime periodically
- Uses `lume.hotswap()` for safe module reload

Usage:
```lua
local hotreload = require("lib.hotreload")

function frame()
    hotreload.update()  -- Check and reload changed files
    -- ...
end
```

## Render Pipeline

`lib/render_pipeline.lua` manages render passes with error recovery:
- Passes implement `get_pass_desc(ctx)` and `execute(ctx, frame_data)`
- Pipeline wraps execution in pcall to prevent shader errors from crashing
- Shader compile errors are logged but don't panic

```lua
local pipeline = require("lib.render_pipeline")
pipeline.register(geometry_pass)
pipeline.register(lighting_pass)

function frame()
    pipeline.execute(ctx, frame_data)
end
```

## Asset Pipeline

Convert assets from 3d-game-shaders-for-beginners:

```bash
# Setup venv and install Panda3D
uv venv .venv
uv pip install panda3d

# Convert .bam to .egg and copy textures
.venv/Scripts/python scripts/bam2egg.py

# Convert .egg to Lua model data
.venv/Scripts/python scripts/egg2lua.py assets/mill-scene/mill-scene.egg assets/mill-scene/mill-scene.lua
```

### Asset Path Convention

Model code loads textures relative to scene:
```lua
local model_name = "mill-scene"
local texture_base = "assets/" .. model_name .. "/tex/"
-- Loads: assets/mill-scene/tex/<texture>.png
```

Shared images (LUT, noise, etc.) are in `assets/images/`.
